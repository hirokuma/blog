# ncs: マルチスレッド

<i>2024/09/04</i>

一昔前、組み込みソフトの仕事は起動処理を作ったりドライバーを作ったりして、最後にアプリがあった。
まあ、並行して進めるので最後にということもないのだが、下から上まで一から作ることが多かった。

比較的小さいマイコンで OS は載っていなかった。  
なので、そういうのにかかりっきりな感じでサイズも大きくならない、CPU もそんなに速くない。
そういう状況なので、アプリも制御が主で複雑というよりはリソースが少ないのをやりくりするのが面倒というところだった。

しかし、今やどうかね。  
そういう分野ももちろん残っているだろうが、マイコンメーカーはサンプルではなく標準で OS をセットにしているところも少なくない。
Nordic のマイコンが ncs/Zephyr を採用したのも最近の流れだろう。

OS を採用して頼りたくなるのはリソース管理、中でもタスク管理だろう(個人の感想です)。  
メインループを 10msec ごとに回して、それをカウントして回数に達したらタスクを呼び出す、みたいなのは自分でやりたくないものだ。

というわけで、今回はマルチスレッドをやっていこう。  
前置きが長くなって済まん。

----

## [Lesson 7 – Multithreaded applications](https://academy.nordicsemi.com/courses/nrf-connect-sdk-fundamentals/lessons/lesson-7-multithreaded-applications/)

OS を使ってタスク管理できると楽になるとはいっても、そもそもタスク管理自体が面倒なものだ。  
それを実装しなくて済んだからといっても、しくみを把握していないと

### Threads

* Zephyrでは`main()`はオプションだそうな。
  * まあ、単なるエントリーポイントだからなんでもいいよね
  * `int main()`だと戻り値がいるけど、使わないなら`void main()`でもよいのかな？
    * サブルーチン呼び出しではなく、`noreturn`
    * まあ、その分をケチってもたかが知れてるだろうし、変なことはしないほうがよいか
* スレッドの種類
  * cooperative thread(優先度値がマイナス)
    * 優先度が低い上に用途がかなり制限されているので(very limited usage)ここでは説明しない。
  * preemptible thread(優先度値が非マイナス)
    * "plus" ではなく "non-negative" ということは 0以上ということかな？
* スレッドの状態
  * Running: CPUによって実行中
  * Runnable(Ready): 実行待ち
    * CPU時間待ちだけになっている
  * Non-runnable(Unready): 実行不可
    * 2つ以上の要因(1つは CPU時間かもしれない)で妨げられている
    * 終了しているのもこの状態になるようだ
* スレッドの実行単位
  * System thread
    * Zephyr RTOS が初期化時に自動で実行するスレッド
    * デフォルトで以下が実行される
      * main thread: いわゆる`main()`相当。なかったらそのまま終了する。
      * idle thread: 何もやることがないとき
  * User-created thread
    * ユーザが作ったスレッド
  * Workqueue thread
    * kernel が持つ workqueu というオブジェクトに突っ込まれた作業を順番にやっていく
    * 割り込みハンドラや緊急度が高い処理が workqueue に作業を突っ込んで負荷分散させるような使い方らしい
    * "work item" はスレッドではなくスレッドで実行したい処理のことか？
    * workqueue はシステムに複数持たせることができる
      * デフォルトは "system workqueue" と呼ばれる
        * system workqueue の処理を行うスレッドは System thread
    * "other equal priority threads are not blocked for a long time" とはどういう意味だろう？
      * work item ごとにスレッドを作るわけではなく、同じスレッドを使い回すような動きか
      * FIFO なので優先度とか関係なくいつかは実行されるということを言いたい？
* スレッドの優先度
  * 値が小さい方が優先度が高い
  * cooperative thread が Running になると、それを Non-runnable にするまでそのままになってしまう
  * preemptible thread に関連付けられた優先度の数はデフォルトで 15(`CONFIG_NUM_PREEMPT_PRIORITIES`)
    * 優先度値ではなく、優先度の数よね？
  * cooperative thread のそれはデフォルトで 16(`CONFIG_NUM_COOP_PRIORITIES`)

### Scheduler

* Zephyr は定期的なタイマー割込み(tick)を持たないタイプだそうだ
  * tickless RTOS
  * イベント駆動のみ
* 再スケジュールは次に実行するスレッドの選択時に行われる
  * `k_yield()`: Running --> Ready
  * kernel synchronize object(semaphore, mutex, alert): Unready --> Ready
  * receiving thread: Waiting  --> Ready
  * time slice: Running --> Ready
* "Ready" の中から優先度で "Running" にするスレッドを選ぶのだろう
* tickがないのであれば、トリガになるのは割り込みハンドラか今動いているスレッドよりも高い優先度のスレッドが来た、あるいはスレッドが動いていない(idle thread)のどれかだろう。

### ISR

割込みハンドラー。

スレッドの優先度は Arm の割り込みレベルと連動しているのだろうか？  
多重割込みを許したのと同じような動作だと考えたのだが。

Exercise にあるようだからそこまで待ってみよう。