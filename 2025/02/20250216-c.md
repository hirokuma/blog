# clang: Mbed TLSとPSA

_2025/02/16_

## はじめに

Mbed TLS をビルドしよう。  
WSL2 を使う。

## ビルド

Mbed TLS は組み込みソフトウェアでよく使われる crypto ライブラリの1つである。
最近組み込んでいない私だが、以前はよくお世話になった。

* [Getting Started — Mbed TLS documentation](https://mbed-tls.readthedocs.io/en/latest/getting_started/)

これを書いている時点での最新 release は v3.6.2 だったのでそれを使う。  
手順に書いてある通りなのだが、`git submodule` しないと `make` に失敗する。
`make` に失敗したときに指示が出るのでその通りにやれば良いだけだ。  
クロスコンパイルの仕方も書いてあるので Mbed TLS らしい。

```console
$ git clone https://github.com/Mbed-TLS/mbedtls.git
$ cd mbedtls
$ git checkout -b mbedtls-3.6.2 refs/tags/mbedtls-3.6.2
$ git submodule update --init
$ make
$ ls library/*.a
library/libmbedcrypto.a  library/libmbedtls.a  library/libmbedx509.a
```

v3.6.2 のビルドに必要なツールは[こちら](https://github.com/Mbed-TLS/mbedtls/tree/v3.6.2?tab=readme-ov-file#tool-versions)に書いてある。
私の環境では既にインストールされていたのか何も言われなかったので特に言えることはない。

ヘッダファイルで設定を変更することもできる。

* [How to configure Mbed TLS](https://mbed-tls.readthedocs.io/en/latest/kb/compiling-and-building/how-do-i-configure-mbedtls/)
  * [https://github.com/Mbed-TLS/mbedtls/tree/v3.6.2/configs](https://github.com/Mbed-TLS/mbedtls/tree/v3.6.2/configs)

`make install` のインストール先は `$DESTDIR` で `/usr/local` だ。  
`make` の引数にすると変更できるのか。知らなかった。。。  
ビルドした実行ファイルもインストールされるようだ。
サンプルコードはほしいけど実行ファイルは個人的にはいらないんだけどね。73ファイルもあるし。

```console
$ make DESTDIR=$HOME/.local
$ mbedtls_hello

  MD5('Hello, world!') = 6cd3556deb0da54bca060b4c39479839
```

## PSA

最近の Mbed TLS といえば PSA 対応だろう、と勝手に思っている。  
ML でも v4.0 のリリースタイムラインどうとか流れてたし。
まだリリースは先のことだが PSA の方がデフォルトになるとか書いてあった。

* [\[Mbed-tls-announce\] Mbed TLS 4.0/TF-PSA Crypto 1.0 release timeline - mbed-tls - lists.trustedfirmware.org](https://lists.trustedfirmware.org/archives/list/mbed-tls@lists.trustedfirmware.org/thread/3MM3XIPGVAIUSX7PJ7BDILSNFRPXHBC5/)

ただ残念な感じがするのは [General application layout](https://github.com/Mbed-TLS/mbedtls/blob/v3.6.2/docs/psa-transition.md#general-application-layout) によると
リソース解放に `mbedtls_psa_crypto_free()` を呼び出すそうだ。  
確かに[サンプル](https://mbed-tls.readthedocs.io/en/latest/getting_started/psa/#importing-a-key) もそれで終わっている。  
そして `valgrind` でも `psa_crypto_init()` だけ呼んで `mbedtls_psa_crypto_free()` を呼ばないとリークしていた。  
恐るべし。。。

* [commit](https://github.com/hirokuma/mbedtls-psa-example/blob/77307c6f5f89cac4080ed0cd3753f1ed48143c69/test1.c)

ライブラリ管理の API を見ても PSA には終わりとして呼ぶ関数は定義されていないようだ。  
完全にライブラリ非依存というのは無理そうだ。

* [8. Library management reference — PSA Crypto API 1.0.1 documentation](https://arm-software.github.io/psa-api/crypto/1.0/api/library/index.html)

まあ、それならそれでプリプロセスとポストプロセスをライブラリごとに実装して`#ifdef`などしていけばよいか。

## おわりに

ちょっとだけ Mbed TLS で PSA の関数を使ってみた。  
初期化だけなので使ったというのもおこがましいが、include とリンクが解決できることが確認できればあとは呼び出すだけなのでよいのだ。
