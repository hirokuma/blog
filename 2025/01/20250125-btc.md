# btc: bitcoinjs-lib を使う (4)

_2025/01/24_

## はじめに

P2TR を扱うのに node.js で使える bitcoinjs-lib を使ってみよう。
前回は key path だったので、今回は script path を扱う。

* [bitcoinjs/bitcoinjs-lib: A javascript Bitcoin library for node.js and browsers.](https://github.com/bitcoinjs/bitcoinjs-lib)

* bitcoin.conf

```conf
server=1
txindex=1
regtest=1
rpcuser=user
rpcpassword=pass
fallbackfee=0.00001
```

* 手順

```bash
rm -rf ~/.bitcoin/regtest/
bitcoind -regtest -daemon
sleep 5
bitcoin-cli -regtest -named createwallet wallet_name=test load_on_startup=true
addr=`bitcoin-cli -regtest getnewaddress`
bitcoin-cli -regtest generatetoaddress 110 $addr
```

* npm install

```bash
npm install bip32@v4 bitcoinjs-lib@v6 ecpair@v2 ky@v1 tiny-secp256k1@v2
npm install -D @types/node eslint @eslint/js typescript@v5 typescript-eslint
```

## script path しか使えないようにする場合

[BIP-341](https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki#constructing-and-spending-taproot-outputs) にこういう記述がある。

> In order to avoid leaking the information that key path spending is not possible it is recommended to pick a fresh integer r in the range 0...n-1 uniformly at random and use H + rG as internal key.

`H + rG` って `r` を秘密鍵にするんだから、それを知っている人は key path で解けてしまうんじゃないの？と思ったのだ。

もしかしたらこの人なら教えてくれるのではと ChatGPT 氏に訊いてみた。  
うーーん・・・力強く説明してくれるのだが納得できていない。。。  
彼/彼女 は調子が良いので、こちらから具体的な返信をすると「そうそう、そうなんです！」みたいなことをいってくるので心配になるのよね。  
無料版を使っているからだろうか。

`Q = P + tG` なので `H + rG` もその部分の話と混同していたが、"as internal key" なので `p` の話だ。  
単純に、internal private key を作らずにいきなり internal public key のデータだけ作りましょう、ということだ。  
`rG` は private key `r` の public key だが、 `H + rG` は少なくとも `r` の public key ではない。  
何らかの private key に対応するかもしれないが、それは「public key から private key は復元できない」ということになっているのと同じことだ。  
そういう解釈だろう。

複数人で管理するスクリプトで、internal public key に `H + rG` を使ったように見せかけて `rG` を使うようなあくどいことをされるかもしれない。  
internal public key を決めるときはみんなで決めようね。
